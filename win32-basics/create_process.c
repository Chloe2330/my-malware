#include <stdlib.h>
#include <stdio.h>
#include <stdbool.h>
#include <windows.h>

BOOL activeProcess(DWORD PID) {
  HANDLE pHandle = OpenProcess(
    SYNCHRONIZE, FALSE, PID);
  
  if (pHandle == NULL) { 
    printf("Could not get handle to process (%ld), error: %ld\n", PID, GetLastError()); 
    return false;
  }

  // Process object/PID are still maintained by the OS until all handles are closed, even if the process has already exited

  if (WaitForSingleObject(pHandle, 0) == WAIT_TIMEOUT) { // non-signaled state = active process
    CloseHandle(pHandle);
    return true;
  }
  else {
    return false;
  }
}

int main(void) {
  STARTUPINFOW startInfo = {0};
  PROCESS_INFORMATION procInfo = {0};

  if (!CreateProcessW(
        L"C:\\Windows\\System32\\notepad.exe", 
        NULL, 
        NULL, 
        NULL, 
        FALSE, 
        BELOW_NORMAL_PRIORITY_CLASS,
        NULL, 
        NULL,
        &startInfo, 
        &procInfo
    )) {
      printf("Failed to create process, error: %ld", GetLastError());
      return EXIT_FAILURE; 
  }

  DWORD PID = procInfo.dwProcessId; 
  printf("Process started! PID: %ld\n", procInfo.dwProcessId);

  while (true) {
    Sleep(5000);

    if(activeProcess(PID)) {
      printf("Process is active! PID: %ld\n", procInfo.dwProcessId);
    }
    else {
      printf("Process is dead, exiting...\n");
      break;
    }
  }

  return EXIT_SUCCESS;
}
